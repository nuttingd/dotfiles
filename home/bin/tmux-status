#!/usr/bin/env bash

# tmux-status: Modular tmux status bar orchestrator with powerline separators
# Usage: tmux-status component:ttl [component:ttl ...]
# Example: tmux-status calendar:60 spotify:1 clock:1 moon:3600

CACHE_DIR="$HOME/.cache/tmux-status"
SCRIPT_DIR="$(dirname "$(readlink -f "$0" 2>/dev/null || echo "$0")")"

# Load theme colors
source "$SCRIPT_DIR/tmux-theme"

# Powerline separator (left-pointing chevron for status-right)
SEP=$'\ue0b2'

# Status bar background
BAR_BG="$THEME_BASE"

# Component background colors - Proper RGB gradient
# Left side: Blue gradient (darkest to lighter)
# Right side: Purple gradient (darkest to lighter)
declare -A COMPONENT_BG=(
    [calendar]="#1a2332"            # Darkest blue
    [spotify]="#1e2d42"             # Very dark blue
    [email]="#223752"               # Dark blue
    [slack]="#264162"               # Medium dark blue
    [clock]="#2d2342"               # Dark purple
    [moon]="#372d52"                # Medium dark purple
    [battery]="#413762"             # Lighter dark purple
)

# Foreground colors for each component (all use light text on dark backgrounds)
declare -A COMPONENT_FG=(
    [calendar]="$THEME_TEXT"        # Light text
    [spotify]="$THEME_TEXT"         # Light text (handled by component)
    [email]="$THEME_TEXT"           # Light text
    [slack]="$THEME_TEXT"           # Light text
    [clock]="$THEME_TEXT"           # Light text
    [moon]="$THEME_TEXT"            # Light text
    [battery]="$THEME_TEXT"         # Light text
)

# Components with different exit colors (e.g., progress bars)
declare -A COMPONENT_BG_EXIT=(
    [spotify]="#223752"             # Transition within blue gradient
)

# Components that handle their own formatting (don't apply orchestrator colors)
declare -A SELF_FORMATTED=(
    [spotify]=1
)

mkdir -p "$CACHE_DIR"

get_component() {
    local component="$1"
    local ttl="$2"
    local cache_file="$CACHE_DIR/$component"
    local now
    now=$(date +%s)

    # Check cache
    if [[ -f "$cache_file" ]]; then
        local cached_at
        cached_at=$(head -1 "$cache_file")
        local age=$((now - cached_at))

        if [[ $age -lt $ttl ]]; then
            # Return cached content (skip first line which is timestamp)
            tail -n +2 "$cache_file"
            return
        fi
    fi

    # Find and run component script
    local script=""
    for path in "$SCRIPT_DIR/tmux-status-$component" "$HOME/bin/tmux-status-$component"; do
        if [[ -x "$path" ]]; then
            script="$path"
            break
        fi
    done

    if [[ -z "$script" ]]; then
        return
    fi

    # Run component and cache result
    local output
    output=$("$script" 2>/dev/null)

    # Write cache (timestamp on first line, content after)
    {
        echo "$now"
        echo -n "$output"
    } > "$cache_file"

    echo -n "$output"
}

# Collect all component outputs and their backgrounds
declare -a components=()
declare -a outputs=()
declare -a backgrounds=()

for arg in "$@"; do
    # Parse component:ttl
    component="${arg%%:*}"
    ttl="${arg##*:}"

    # Default TTL if not specified
    [[ "$component" == "$ttl" ]] && ttl=1

    result=$(get_component "$component" "$ttl")

    if [[ -n "$result" ]]; then
        components+=("$component")
        outputs+=("$result")
        backgrounds+=("${COMPONENT_BG[$component]:-}")
    fi
done

# Build powerline output
output=""
prev_bg=""

for i in "${!components[@]}"; do
    component="${components[$i]}"
    content="${outputs[$i]}"
    bg="${backgrounds[$i]}"

    if [[ -n "$bg" ]]; then
        # Component has a background - add powerline separator
        if [[ -z "$prev_bg" ]]; then
            # First component with bg, transition from bar background
            output+="#[fg=$bg,bg=$BAR_BG]$SEP"
        else
            # Transition from previous component
            output+="#[fg=$bg,bg=$prev_bg]$SEP"
        fi
        # Apply colors to content (unless component handles its own formatting)
        if [[ -n "${SELF_FORMATTED[$component]}" ]]; then
            # Component provides its own formatting (e.g., spotify progress bar)
            output+="$content"
        else
            # Apply orchestrator colors with component-specific foreground
            fg="${COMPONENT_FG[$component]:-$THEME_TEXT}"
            output+="#[fg=$fg,bg=$bg,bold]$content"
        fi
        # Use exit color if defined, otherwise use entry color
        prev_bg="${COMPONENT_BG_EXIT[$component]:-$bg}"
    else
        # Component has no background (renders on bar background)
        if [[ -n "$prev_bg" ]]; then
            # Close previous segment back to bar
            output+="#[fg=$BAR_BG,bg=$prev_bg]$SEP#[fg=default,bg=default]"
            prev_bg=""
        fi
        output+=" $content"
    fi
done

# Close final segment if needed
if [[ -n "$prev_bg" ]]; then
    output+="#[fg=$BAR_BG,bg=$prev_bg]$SEP#[fg=default,bg=default]"
fi

echo -n "$output"
